/* Based on:
// https://raw.githubusercontent.com/redhat-cop/container-pipelines/master/basic-spring-boot/Jenkinsfile

library identifier: "pipeline-library@v1.5",
retriever: modernSCM(
  [
    $class: "GitSCMSource",
    remote: "https://github.com/redhat-cop/pipeline-library.git"
  ]
)

// The name you want to give your Spring Boot application
// Each resource related to your app will be given this name
appName = "hnsesb"
*/
pipeline {
    agent any

    stages {
        
        stage('Checkout') {
            steps {
                // Get some code from a GitHub repository
                echo "Getting code from main"
                git branch: "${BRANCH}", url: "https://github.com/bcgov/moh-hni-esb"
            }
            
        }
        stage("Start Openshift build process") {
            steps {
                // This uploads your application's source code and performs a binary build in OpenShift
                // This is a step defined in the shared library (see the top for the URL)
                // (Or you could invoke this step using 'oc' commands!)
                //binaryBuild(buildConfigName: appName, buildFromPath: ".")
				openshift.withCluster( 'openshift' ) { 
					openshift.withCredentials( 'deployer-tools-oc-plugin' ) {
							openshift.withProject('${NAMESPACE}'){
								echo "Using project: ${openshift.project()} in cluster ${openshift.cluster()} "
								def bcSelector = openshift.selector( "buildconfig", "${BUILD_NAME}")
								def bc
								if(bcSelector.exists()){
									bc = bcSelector.object();
									def buildSelector = bc.startBuild()
									buildSelector.logs('-f')
								}else{
									echo "Please provide valid build name"
								}
							}
					
					}
				}
				
            }
        }
    }
    post {
        always {
            echo "Complete"
        }
    }
}
