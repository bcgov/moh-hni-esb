// This pipeline will deploy the provided build number to selected environment
pipeline {
	parameters {
		choice(name: 'NAMESPACE', choices: ['Dev', 'Test'], description: 'Project namespace in openshift where you want to create this application')
		text(name: 'Application', defaultValue: 'hnsesb-sample', description: 'Enter the name of application. If not known, get this value from URL. For example URL be: http://hnsesb-sample.apps.silver.devops.gov.bc.ca/ for app hnsesb-sample. If application does not exist, this job will fail')
		choice(name: 'DEPLOY_BUILD_TYPE', choices: ['Feature', 'Release'], description: 'Feature build is created from hnsesb-buildAndDeploy job. Release build is created from hnsesb-release-buildAndDeploy job.')
		string(name: 'DEPLOY_BUILD_NUMBER', defaultValue: '', description: 'Build number in text from hnsesb-buildAndDeploy job for Feature build and hnsesb-release-buildAndDeploy job for Release build.')
	}

    environment {
    	// Input from user: NAMESPACE and DEPLOY_BUILD_NUMBER
    	CLUSTER = "openshift"
    	OC_JEKNINS_USER = "deployer-c5839f-tools"
		TOOLS_PROJECT = "c5839f-tools"
		IMAGE_STREAM = "image-registry.openshift-image-registry.svc:5000/c5839f-tools/hnsesb"
	}
	
    agent any

    stages {
		stage ("Load groovy utility"){
			steps {
				script {
					util=load "jenkins/jenkins.groovy"
					PROJECT = util.project("${NAMESPACE}")
					APP_NAME = util.lower("${Application}")
					BUILD_DEPLOY_TAG = util.deployTag("${DEPLOY_BUILD_NUMBER}","${DEPLOY_BUILD_TYPE}")
					IMAGE_STREAM_TAG = "imagestreamtag/hnsesb:${BUILD_DEPLOY_TAG}"		
					//eg : imagestreamtag/hnsesb:BUILD-DEPLOY-12 
				}
			}
		}

        stage('Verify if application and build exists') {
            steps {
            	script {
                    openshift.withCluster( "${CLUSTER}" ) {
                        openshift.withCredentials( "${OC_JEKNINS_USER}" ) {
                            openshift.withProject("${TOOLS_PROJECT}"){
                            	// Checking if build exists
                                echo "Using project: ${openshift.project()} in cluster ${openshift.cluster()} "
                                def is = openshift.selector( "imagestreamtag/hnsesb:${BUILD_DEPLOY_TAG}").object()
								// Job will fail if object does not exist
								def name = is.metadata.name
								echo "name is ${name}"
								
                            }
							openshift.withProject("${PROJECT}"){
                                // Checking if application exists
                                echo "Using project: ${openshift.project()} in cluster ${openshift.cluster()} "
                                echo "Checking if application exists"
								util.verifyPods("${Application}")
                            }
                        }
                    }            		
            	}
            }
            
        }

        stage ('Deploy selected build to project') {
            steps {
                script {
                    openshift.withCluster( "${CLUSTER}" ) {
                        openshift.withCredentials( "${OC_JEKNINS_USER}" ) {
                            openshift.withProject("${TOOLS_PROJECT}"){
                                echo "Tag the build ${IMAGE_STREAM}:${BUILD_DEPLOY_TAG} with tag: ${APP_NAME} "
                                openshift.tag( "${IMAGE_STREAM}:${BUILD_DEPLOY_TAG}", "c5839f-tools/hnsesb:${APP_NAME}")
                            }
                        }
                    }
                }
            }
        }
    }
}